<?xml version="1.0" encoding="UTF-8"?>
<upload>
    <date>
        <nowTime type="yyyymmddHHMMSS">nowTime</nowTime>
        <nowDay type="yyyymmdd">nowDay</nowDay>
        <lastDay type="yyyymmdd">lastDay</lastDay>
        <twoDaysAgo type="yyyymmdd">twoDaysAgo</twoDaysAgo>
        <threeDaysAgo type="yyyymmdd">threeDaysAgo</threeDaysAgo>
        <nowMonth type="yyyymm">nowMonth</nowMonth>
        <lastMonth type="yyyymm">lastMonth</lastMonth>
    </date>
    <constant>
        <FILE_NAME replaceStr="lastDay">a_13000_$lastDay_IOP-93002_00</FILE_NAME>
        <binPath>C:\Users\40468\Desktop\iopFile</binPath>
        <className>com.asiainfo.msooimonitor.model.datahandlemodel.Upload93002</className>
    </constant>
    <sql>
        <step1>
            truncate table fcm.iop_93002_processid immediate
        </step1>
        <step2>
            truncate table fcm.iop_93002_activity_info_2_7 immediate
        </step2>
        <step3>
            truncate table fcm.iop_93002_campaign_info_2_7 immediate
        </step3>
        <step4>
            truncate table fcm.iop_93002_activity_pg_2_7 immediate
        </step4>
        <step5>
            truncate table fcm.iop_93002_upload immediate
        </step5>
        <step6 replaceStr="threeDaysAgo" replaceType="String">
            insert into fcm.iop_93002_processid select b.ACTIVITY_ID,c.flow from fcm.activity_info a right join (select distinct activity_id,rule_value from fcm.activity_channel_info where rule_id='R002' and channel_id='q07') b on a.ACTIVITY_ID=b.ACTIVITY_ID left join qcd.activity_flow_info c on b.rule_value=c.position_id where a.STOPPED='0'and a.DELETED='0' and to_char(a.END_TIME,'yyyymmdd')= '$threeDaysAgo'
        </step6>
        <step7 replaceStr="threeDaysAgo" replaceType="String">
            insert into fcm.iop_93002_processid select distinct CAMPAIGN_ID,'1' from qcd.IOP_G2PACTDOWN_REL a left join qcd.marking_campaign_info b on a.CAMPAIGN_ID = b.CAMPAIGNID where to_char(to_date(CAMPAIGNENDTIME,'yyyy/mm/dd hh24:mi:ss'),'yyyymmdd') = '$threeDaysAgo' and b.CAMPAIGNID is not null
        </step7>
        <step8 replaceStr="threeDaysAgo" replaceType="String">
            insert into fcm.iop_93002_processid select distinct a.activity_id,'3' from fcm.activity_info a where a.activity_id not in (select ACTIVITY_ID from fcm.iop_93002_processid ) and a.STOPPED='0'and a.DELETED='0' and to_char(a.END_TIME,'yyyymmdd')= '$threeDaysAgo'
        </step8>
        <step9>
            insert into fcm.iop_93002_activity_info_2_7  select
            (case when (a.processid ='1') then '028' else f.CITY end),
            (case when (a.processid ='1') then e.ACTIVITYID when (a.processid in (select distinct flow from qcd.activity_flow_info)) then '280'||substr(b.activity_id,2,13) else b.activity_id end) as activity_id,
            (case when (a.processid ='1') then e.ACTIVITYNAME else b.activity_name end) as activity_name,
            (case when (a.processid ='1') then to_char(to_date(d.CAMPAIGNSTARTTIME,'yyyy/mm/dd hh24:mi:ss'),'yyyymmddHH24mmss') else to_char(b.start_time,'yyyymmddHH24mmss') end) as activity_starttime,
            (case when (a.processid ='1') then to_char(to_date(d.CAMPAIGNENDTIME,'yyyy/mm/dd hh24:mi:ss'),'yyyymmddHH24mmss') else to_char(b.end_time,'yyyymmddHH24mmss') end) as activity_endtime,
            (case when (a.processid ='1') then e.ACTIVITYTYPE else b.BUSINESS_TYPE_ID end),
            (case when (a.processid ='1') then e.ACTIVITYOBJECTIVE else b.MARKETING_PURPOSE_ID end),
            (case when (a.processid ='1') then e.ACTIVITYDESCRIBE else b.ACTIVITY_NAME end),
            (case when (a.processid ='1') then e.PCCID else '' end),
            a.processid
            from fcm.iop_93002_processid a
            left join fcm.activity_info b on a.ACTIVITY_ID=b.ACTIVITY_ID
            left join qcd.marking_campaign_info d on a.ACTIVITY_ID=d.CAMPAIGNID
            left join qcd.MARKING_ACTIVITY_INFO e on e.ACTIVITYID = d.ACTIVITYID
            left join fcm.iop_93001_city f on b.CITY_ID = f.IOP_CITY
            where  a.ACTIVITY_ID is not null
        </step9>
        <step10>
            insert into  fcm.iop_93002_campaign_info_2_7 select * from  (select row_number() over(partition by a.ACTIVITY_ID order by a.ACTIVITY_ID ) as num,
            (case when (a.processid ='1') then c.ACTIVITYID else b.ACTIVITY_ID end),
            (case when (a.processid ='1') then c.CAMPAIGNID else b.ACTIVITY_ID end),
            (case when (a.processid ='1') then c.CAMPAIGNNAME else b.ACTIVITY_NAME end),
            (case when (a.processid ='1') then to_char(to_date(c.CAMPAIGNSTARTTIME,'yyyy/mm/dd hh24:mi:ss'),'yyyymmddHH24mmss')  else to_char(b.start_time,'yyyymmddHH24mmss') end),
            (case when (a.processid ='1') then to_char(to_date(c.CAMPAIGNENDTIME,'yyyy/mm/dd hh24:mi:ss'),'yyyymmddHH24mmss')  else to_char(b.END_TIME,'yyyymmddHH24mmss') end),
            '自定义','自定义','','','自定义',
            (case when (a.processid ='1') then d.OFFERCODE else '0428000'||e.PRODUCT_ID end),
            (case when (a.processid ='1') then substr(d.OFFERCODE,1,7) else '0428000' end),
            (case when (a.processid ='1') then d.OFFERNAME else e.PRODUCT_NAME end),
            (case when (a.processid ='1') then d.OFFERTYPE else e.PRODUCT_TYPE end),
            (case when (a.processid ='1') then c.CHANNELID else '28005'||f.CHANNEL_id end),
            (case when (a.processid ='1') then substr(c.CHANNELID,1,3) else '280' end),
            (case when (a.processid ='1') then substr(c.CHANNELID,4,2) else '05' end),
            (case when (a.processid ='1') then c.CHANNELNAME else f.CHANNEL_NAME end),
            (case when (a.processid ='1') then c.CHANNETYPE else '02010301' end),'',
            (case when (a.processid ='1') then c.TIMEID else '0' end),
            (case when (a.processid ='1') then c.TIMEDISTINDES else '' end)
            from
            fcm.iop_93002_processid a
            left join fcm.activity_info b on a.ACTIVITY_ID=b.ACTIVITY_ID
            left join qcd.marking_campaign_info c on a.ACTIVITY_ID=c.CAMPAIGNID
            left join qcd.MARKING_CAMPAIGN_OFFERBO_INFO d on c.CAMPAIGNID = d.CAMPAIGNID
            left join fcm.activity_recommend_product e on e.ACTIVITY_ID=a.ACTIVITY_ID
            left join fcm.ACTIVITY_CHANNEL_INFO f on f.ACTIVITY_ID = a.ACTIVITY_ID ) where num =1
        </step10>
        <step11>
            insert into fcm.iop_93002_activity_pg_2_7 select a.ACTIVITY_ID,a.ACTIVITY_ID,'','','','','','','',
            (case when sum(b.TOUCH_NUM) is null then 0 else sum(b.touch_num) end),
            (case when sum(b.OBJ_NUM) !=0 then to_char(DECIMAL(sum(b.TOUCH_NUM)/sum(b.OBJ_NUM*1.000),20,6)) else '0.000000' end),
            (case when sum(b.TOUCH_NUM) !=0 then to_char(DECIMAL(sum(b.VIC_NUM)/sum(b.TOUCH_NUM*1.000),20,6)) else '0.000000' end),
            (case when sum(b.vic_num) is null then 0 else sum(b.vic_num) end),
            (case when sum(b.TOUCH_NUM) !=0 then to_char(DECIMAL(sum(b.VIC_NUM)/sum(b.TOUCH_NUM*1.000),20,6)) else '0.000000' end)
            from
            fcm.iop_93002_processid a
            left join qcd.activity_pg_activity b on a.ACTIVITY_ID = b.CAMP_ID
            where b.TOUCH_NUM > 0 and b.vic_num >0 and a.PROCESSID !=1 group by a.ACTIVITY_ID
        </step11>
        <step12>
            insert into fcm.iop_93002_activity_pg_2_7 select distinct e.ACTIVITY_ID,d.* from(select a.ACTIVITY_ID,'','','','','','','',
            (case when sum(c.TOUCH_NUM) is null then 0 else sum(c.TOUCH_NUM) end),
            (case when sum(c.OBJ_NUM) !=0 then to_char(DECIMAL(sum(c.TOUCH_NUM)/sum(c.OBJ_NUM*1.000),20,6)) else '0.000000' end),
            (case when sum(c.TOUCH_NUM) !=0 then to_char(DECIMAL(sum(c.vic_num)/sum(c.TOUCH_NUM*1.000),20,6)) else '0.000000' end),
            (case when sum(c.vic_num) is null then 0 else sum(c.vic_num) end),
            (case when sum(c.TOUCH_NUM) !=0 then to_char(DECIMAL(sum(c.vic_num)/sum(c.TOUCH_NUM*1.000),20,6)) else '0.000000' end)
            from
            fcm.iop_93002_processid a
            left join qcd.IOP_G2PACTDOWN_REL b on a.ACTIVITY_ID = b.CAMPAIGN_ID
            left join qcd.activity_pg_activity c on b.CAMP_ID = c.CAMP_ID
            where c.TOUCH_NUM > 0 and c.vic_num > 0 and a.PROCESSID=1 group by a.ACTIVITY_ID) d left join qcd.IOP_G2PACTDOWN_REL e on d.ACTIVITY_ID=e.CAMPAIGN_ID
        </step12>
        <step13 replaceStr="nowTime" replaceType="String">
            insert into fcm.iop_93002_upload (row_number,
            OP_TIME,
            province,
            city,
            activity_id,
            activity_name,
            activity_start_time,
            activity_end_time,
            activity_type,
            activity_object,
            activity_desc,
            pcc_id,
            activity_process,
            camp_id,
            camp_name,
            camp_start_time,
            camp_end_time,
            customer_id,
            customer_name,
            customer_count,
            customer_desc,
            CUSTOMER_FILETER,
            PRO_ID,
            PRO_SUB_ID,
            PRO_NAME,
            PRO_TYPE,
            CHANNEL_ID,
            CHANNEL_ID_ONE,
            CHANNEL_ID_TWO,
            CHANNEL_NAME,
            CHANNEL_TYPE,
            CHANNEL_TOUCH_TYPE,
            TIMES,
            TIMES_DESC,
            customer_quality_info,
            source_uesd,
            pv,
            click_num,
            uv,
            transaction_num,
            customer_phone,
            touch_num,
            touch_rate,
            response_rate,
            vic_num,
            vic_rate)
            select row_number() over(),'$nowTime','280',
            b.CITY_ID,b.ACTIVITY_ID,b.ACTIVITY_NAME,b.ACTIVITY_START_TIME,b.ACTIVITY_END_TIME,b.ACTIVITY_TYPE,b.ACTIVITY_OBJECT,b.ACTIVITY_DESC,b.PCC_ID,b.PROCESS_ID,
            a.CAMP_ID,a.CAMP_NAME,a.CAMP_START_TIME,a.CAMP_END_TIME,a.CUSTOMER_ID,a.CUSTOMER_NAME,a.CUSTOMER_COUNT,a.CUSTOMER_DESC,a.CUSTOMER_FILETER,a.PRO_ID,a.PRO_SUB_ID,a.PRO_NAME,a.PRO_TYPE,a.CHANNEL_ID,a.CHANNEL_ID_ONE,a.CHANNEL_ID_TWO,a.CHANNEL_NAME,a.CHANNEL_TYPE,a.CHANNEL_TOUCH_TYPE,a.TIMES,a.TIMES_DESC,
            c.CUSTOMER_QUALITY_INFO,c.SOURCE_UESD,c.PV,c.CLICK_NUM,c.UV,c.TRANSACTION_NUM,c.CUSTOMER_PHONE,c.TOUCH_NUM,
            case when (c.TOUCH_RATE >1.000000) then 1.000000 else c.TOUCH_RATE end
            ,c.RESPONSE_RATE,c.VIC_NUM,
            case when (c.VIC_RATE >1.000000) then 1.000000 else c.VIC_RATE end
            from
            fcm.iop_93002_campaign_info_2_7  a
            left join
            fcm.iop_93002_activity_info_2_7 b on a.ACTIVITY_ID = b. ACTIVITY_ID
            left join
            fcm.iop_93002_activity_pg_2_7 c on a.ACTIVITY_ID = c.CAMP_ID
            where a.CAMP_ID is not null and b.ACTIVITY_ID is not null and c.CAMP_ID is not null and c.TOUCH_NUM >0 and c.VIC_NUM >0
        </step13>
    </sql>
</upload>