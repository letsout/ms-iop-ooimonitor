<?xml version="1.0" encoding="UTF-8"?>
<upload>
    <date>
        <nowTime type="yyyymmddHHMMSS">nowTime</nowTime>
        <nowDay type="yyyymmdd">nowDay</nowDay>
        <lastDay type="yyyymmdd">lastDay</lastDay>
        <twoDaysAgo type="yyyymmdd">twoDaysAgo</twoDaysAgo>
        <threeDaysAgo type="yyyymmdd">threeDaysAgo</threeDaysAgo>
        <nowMonth type="yyyymm">nowMonth</nowMonth>
        <lastMonth type="yyyymm">lastMonth</lastMonth>
    </date>
    <constant>
        <FILE_NAME replaceStr="lastDay"  replaceType="String">i_13000_$lastDay_IOP-93004_00</FILE_NAME>
        <binPath>C:\Users\40468\Desktop\iopFile</binPath>
        <className>com.asiainfo.msooimonitor.model.datahandlemodel.Upload93004</className>
    </constant>
    <sql>
        <!--建立活动表对比是否有新的活动加入-->
        <return  type="String" name="count">
            select count(distinct activity_id) from fcm.iop_93004_new_activity
        </return>
        <step1>
            truncate table fcm.iop_93004_new_activity immediate
        </step1>
        <step2>
            truncate table fcm.iop_93004_upload immediate
        </step2>
        <step3>
            insert into fcm.iop_93004_new_activity select distinct a.activity_id from fcm.activity_channel_info a left join fcm.activity_info b on a.activity_id = b.activity_id where a.rule_id='R002' and a.channel_id='q07' and b.ACTIVITY_STATE=8 and b.STOPPED=0 and b.DELETED=0 and  a.activity_id not in ( select activity_id  from fcm.iop_93004_activity_uploaded)
        </step3>
        <if test="$count > 0">
            <!--有新的活动-->
            <!--建立正在执行中的活动与应用的运营位关系表-->
            <step4>
                drop table fcm.iop_93004_activity_position
            </step4>
            <step5>
                create  table fcm.iop_93004_activity_position (activity_id varchar(50),postition_id varchar(50)) in tbs_app_imcd
            </step5>
            <step6>
                insert into fcm.iop_93004_activity_position select distinct a.activity_id ,a.rule_value from fcm.activity_channel_info a left join fcm.activity_info b on a.activity_id = b.activity_id where a.rule_id='R002' and a.channel_id='q07' and b.ACTIVITY_STATE=8  and b.STOPPED=0 and b.DELETED=0
            </step6>
            <!--新建表iop_93004_PRIORITY 电话号码对应的活动优先级-->
            <step7>
                alter table fcm.iop_93004_PRIORITY activate not logged initially with empty table
            </step7>
            <step8>
                drop table fcm.iop_93004_PRIORITY
            </step8>
            <step9>
                create table fcm.iop_93004_PRIORITY (CAMP_ID varchar(50),PHONE_NO varchar(50),PRIORITY_value varchar(50),position_id varchar(50)) distribute by hash(phone_no) in tbs_app_imcd
            </step9>
            <!--查询用户群里面活动与电话号码对应关系，未distinct,不使用imie号从customer_remove_info 里面取-->
            <step10>
                drop table fcm.iop_93004_activity_phone
            </step10>
            <step11>
                create table fcm.iop_93004_activity_phone (activity_id varchar(50),phone_no varchar(50)) DISTRIBUTE by hash("phone_no") in tbs_app_imcd
            </step11>
            <return  replaceStr="nowDay" replaceType="String"  type="Map" name="afMap" >
                select activity_id,FINAL_GROUP_TABLE_NAME from fcm.ACTIVITY_CUSTOMER_REMOVE_INFO where activity_id in (select a.ACTIVITY_ID from
                FCM.ACTIVITY_INFO a
                left join FCM.ACTIVITY_CHANNEL_INFO b on a.ACTIVITY_ID=b.ACTIVITY_ID
                left join (select * from (select row_number() over(partition by ACTIVITY_ID order by product_id ) as num,ACTIVITY_ID,PRODUCT_ID,PRODUCT_NAME from
                FCM.ACTIVITY_RECOMMEND_PRODUCT where product_id is not null and PRODUCT_NAME is not null ) where num=1) d
                on a.ACTIVITY_ID = d.ACTIVITY_ID
                where
                b.CHANNEL_ID='q07' and
                a.ACTIVITY_STATE='8' and
                b.RULE_ID = 'R002' and
                a.DELETED='0' and
                a.STOPPED='0' and
                a.ACTIVITY_ID not in (select activity_id from fcm.iop_93004_activity_uploaded) and
                to_char(a.END_TIME,'yyyymmdd')>='$nowDay')
            </return>
            <foreach replaceStr1="activity_id" replaceStr2="FINAL_GROUP_TABLE_NAME" replaceType="Map" replaceName="afMap">
                insert into fcm.iop_93004_activity_phone select '$activity_id',phone_no from fcm.$FINAL_GROUP_TABLE_NAME where length(phone_no)='11'
            </foreach>
            <step13>
                insert into fcm.iop_93004_PRIORITY
                select a.ACTIVITY_ID,a.PHONE_NO,b.PRIORITY_VALUE,c.POSTITION_ID
                from
                fcm.iop_93004_activity_phone a
                left join
                fcm.ACTIVITY_PRIORITY_RESULT b on a.activity_id = b.activity_id
                left join
                fcm.iop_93004_activity_position c on c.ACTIVITY_ID = a.ACTIVITY_ID
            </step13>
            <step14>
                alter table fcm.iop_93004_PRIORITY_distinct activate not logged initially with empty table
            </step14>
            <step15>
                drop table fcm.iop_93004_PRIORITY_distinct
            </step15>
            <step16>
                create table fcm.iop_93004_PRIORITY_distinct (CAMP_ID varchar(50),PHONE_NO varchar(50)) distribute by hash(phone_no) in tbs_app_imcd
            </step16>
            <step17>
                insert into fcm.iop_93004_PRIORITY_distinct select CAMP_ID,PHONE_NO from (select row_number() over (partition by PHONE_NO,POSITION_ID order by PRIORITY_VALUE ) as rownum ,a.*  from fcm.iop_93004_PRIORITY  a)as t  where t.rownum=1
            </step17>
            <step18 replaceStr="nowDay" replaceType="String">
                insert into  fcm.iop_93004_upload select distinct row_number() over(),'280','280'||substr(a.ACTIVITY_ID,2,13),a.ACTIVITY_NAME,
                to_char(a.START_TIME,'yyyyMMddHHmmss') ,to_char(a.END_TIME,'yyyyMMddHHmmss'),'280_000_'||substr(a.ACTIVITY_ID,2,13),a.ACTIVITY_NAME,to_char(a.START_TIME,'yyyyMMddHHmmss') ,
                to_char(a.END_TIME,'yyyyMMddHHmmss'),
                c.CHANNELID,substr(CHANNELID,1,3),substr(CHANNELID,4,2),c.CHANNELNAME,c.POSITIONID,substr(POSITIONID,1,3),substr(POSITIONID,4,2),c.POSITIONNAME,
                d.PHONE_NO,'',e.PRODUCT_NAME,concat('0428000',e.PRODUCT_ID),'0428000' from
                FCM.ACTIVITY_INFO a
                left join
                fcm.iop_93004_activity_position b on b.ACTIVITY_ID = a.ACTIVITY_ID
                left join
                qcd.marking_activity_iop_info c on b.POSTITION_ID = c.POSITIONID
                left join
                fcm.iop_93004_PRIORITY_distinct d on d.CAMP_ID = a.ACTIVITY_ID
                left join
                (select * from (select row_number() over(partition by ACTIVITY_ID order by product_id ) as num,ACTIVITY_ID,PRODUCT_ID,PRODUCT_NAME from
                FCM.ACTIVITY_RECOMMEND_PRODUCT where product_id is not null and PRODUCT_NAME is not null ) where num=1) e on e.ACTIVITY_ID = a.ACTIVITY_ID
                left join
                fcm.ACTIVITY_CHANNEL_INFO f on f.ACTIVITY_ID = a.ACTIVITY_ID
                where
                f.CHANNEL_ID='q07' and
                a.ACTIVITY_STATE='8' and
                a.DELETED='0' and
                a.STOPPED='0' and
                to_char(a.END_TIME,'yyyymmdd')>='$nowDay' and d.camp_id is not null and d.phone_no is not null
            </step18>
        </if>
    </sql>
</upload>